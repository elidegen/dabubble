<mat-drawer-container (click)="closeEmojiPicker()" autosize [ngSwitch]="chatService.chatWindow">
  <div *ngIf="chatService.isMobile" class="header-mobile">
    <div class="logo-header-mobile">
      <button mat-icon-button [routerLink]="['/home']">
        <img src="assets/img/icons/chevron_left.svg">
      </button>
      <img class="logo" src="assets/img/icons/workspace-logo.svg"/>
      <span>Code learning</span>
    </div>
    <div class="profile-container">
      <div class="profile-picture" [matMenuTriggerFor]="menu">
        <img src="{{this.userService.currentUser.picture}}" alt="" />
      </div>
      <mat-menu class="menu-mobile" #menu="matMenu" xPosition="before">
        <div class="separator-mobile"></div>
        <button (click)="openProfileDialog(currentUser.id)" class="menu" mat-menu-item>Profile</button>
        <button (click)="logOutUser()" mat-menu-item>Log Out</button>
      </mat-menu>
    </div>
  </div>

  <mat-card class="mr-16">
    <div *ngSwitchCase="'empty'" class="chat-window-container">
      <mat-card-header>
        <div class="header">
        </div>
      </mat-card-header>
      <mat-card-content class="empty-chat-container" *ngSwitchCase="'empty'">
        <span>Please choose a channel or direct message.</span>
      </mat-card-content>
      <mat-card-content class="textfield-content">
        <div class="text-field-container">
          <textarea disabled placeholder="Choose channel or direct Message or start a new conversation"></textarea>
          <div class="message-buttons">
            <div class="attachments">
              <div class="border-right">
                <button disabled mat-icon-button>
                  <img src="assets/img/icons/add.svg" alt="" />
                </button>
              </div>
              <button disabled (click)="openEmojiPickerChat()" mat-icon-button>
                <img src="assets/img/icons/smiley.svg" alt="" />
              </button>
              <button disabled mat-icon-button>
                <img src="assets/img/icons/@.svg" alt="" />
              </button>
            </div>
            <button class="send-button" mat-icon-button disabled>
              <svg width="23" height="20" viewBox="0 0 23 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M2.5 19.2812C2.08333 19.4479 1.6875 19.4112 1.3125 19.1712C0.9375 18.9321 0.75 18.5833 0.75 18.125V13.4687C0.75 13.1771 0.833333 12.9167 1 12.6875C1.16667 12.4583 1.39583 12.3125 1.6875 12.25L10.75 9.99999L1.6875 7.74999C1.39583 7.68749 1.16667 7.54166 1 7.31249C0.833333 7.08333 0.75 6.82291 0.75 6.53124V1.87499C0.75 1.41666 0.9375 1.06749 1.3125 0.827493C1.6875 0.588327 2.08333 0.552076 2.5 0.718743L21.75 8.84374C22.2708 9.07291 22.5312 9.45833 22.5312 9.99999C22.5312 10.5417 22.2708 10.9271 21.75 11.1562L2.5 19.2812Z"
                  fill="#444DF2" />
              </svg>
            </button>
          </div>
        </div>
      </mat-card-content>
    </div>
    <div *ngSwitchCase="'newMessage'" class="chat-window-container">
      <mat-card-header *ngSwitchCase="'newMessage'">
        <div class="w100 headline">
          <h1>New Message</h1>
          <div class="add-members-container">
            <input #search class="w100 input-members" type="text" placeholder="To: @someone"
              [(ngModel)]="firestoreService.searchInput" (input)="filterUsers()" (click)="this.isInputFocused = true;">

            <div class="user-search-container" *ngIf="isInputFocused" (click)="userSelected($event)">
              <button class="user-container" *ngFor="let user of firestoreService.filteredUsers"
                (click)="selectUser(user)">
                <div class="profile-container">
                  <img src="{{user.picture}}" alt="profile">
                  <div [ngClass]="{'offline-status': user.online === false}" class="online-status"></div>
                </div>
                <span>{{user.name}}</span>
              </button>
              <span *ngIf=" firestoreService.filteredUsers.length < 1">No matching contact</span>
            </div>
          </div>
        </div>
      </mat-card-header>

      <mat-card-content class="empty-chat-container">
        <span>Please choose a channel or direct message.</span>
      </mat-card-content>

      <mat-card-content class="textfield-content">
        <div class="text-field-container">
          <textarea disabled placeholder="Choose channel or direct Message or start a new conversation"></textarea>
          <div class="message-buttons">
            <div class="attachments">
              <div class="border-right">
                <button disabled mat-icon-button>
                  <label class="custom-file-upload">
                    <input class="dataInput" (change)="onFileSelected($event)"  type="file">
                    <img src="assets/img/icons/add.svg"/>
                  </label>
                </button>
              </div>
              <button disabled (click)="openEmojiPickerChat()" mat-icon-button>
                <img src="assets/img/icons/smiley.svg"/>
              </button>
              <button disabled mat-icon-button>
                <img src="assets/img/icons/@.svg"/>
              </button>
            </div>
            <button class="send-button" mat-icon-button disabled>
              <svg width="23" height="20" viewBox="0 0 23 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M2.5 19.2812C2.08333 19.4479 1.6875 19.4112 1.3125 19.1712C0.9375 18.9321 0.75 18.5833 0.75 18.125V13.4687C0.75 13.1771 0.833333 12.9167 1 12.6875C1.16667 12.4583 1.39583 12.3125 1.6875 12.25L10.75 9.99999L1.6875 7.74999C1.39583 7.68749 1.16667 7.54166 1 7.31249C0.833333 7.08333 0.75 6.82291 0.75 6.53124V1.87499C0.75 1.41666 0.9375 1.06749 1.3125 0.827493C1.6875 0.588327 2.08333 0.552076 2.5 0.718743L21.75 8.84374C22.2708 9.07291 22.5312 9.45833 22.5312 9.99999C22.5312 10.5417 22.2708 10.9271 21.75 11.1562L2.5 19.2812Z"
                  fill="#444DF2" />
              </svg>
            </button>
          </div>
        </div>
      </mat-card-content>
    </div>

    <div *ngSwitchCase="'channel'" class="chat-window-container">
      <mat-card-header *ngSwitchCase="'channel'">
        <div class="headerChannel">
          <button (click)="openEditChannelDialog()" mat-button class="br-32">
            <div class="chat-title">
              <img src="assets/img/icons/tag-black.svg" alt=""/>
              <h2 class="mr-16">{{ currentChat?.name}}</h2>
              <mat-icon>expand_more</mat-icon>
            </div>
          </button>

          <div *ngIf="!chatService.isMobile" class="group-members-container">
            <button mat-button class="group-members-button" (click)="openMemberDialog()">
              <div class="group-members-container">
                <div class="group-members">
                  <div class="d-flex" *ngFor="let member of firestoreService.firstThreeItems">
                    <img src="{{member.picture}}" />
                  </div>
                </div>
                <h3 *ngIf="firestoreService.allChannelMembers.length > 3" class="member-count"> +
                  {{firestoreService.allChannelMembers.length -3}}</h3>
              </div>
            </button>
            <button mat-icon-button class="add-user" (click)="openDialog()">
              <img src="assets/img/icons/add-person.svg" alt="" />
            </button>
          </div>

          <button *ngIf="chatService.isMobile" mat-icon-button class="add-user" (click)="openDialog()">
            <img src="assets/img/icons/add-person.svg" alt="" />
          </button>
        </div>
      </mat-card-header>

      <mat-card-content #messageContainer class="p-0 main-chat-container" #scrollContainer [scrollTop]="scrollPosition">
        <ng-container *ngFor="let organizedMessage of firestoreService.organizedChannelMessages.slice()">
          <section>
            <div class="date-container">
              <div class="separator"></div>
              <div class="time-box">{{ isToday(organizedMessage.date) ? 'Today' : organizedMessage.date }}</div>
              <div class="separator"></div>
            </div>

            <div (click)="message.messageSelected = false" class="message-row-container" [ngClass]="{'my-messages': message.creatorId == currentUser.id}"
              *ngFor="let message of organizedMessage.messages">
              <div class="message-box">
                <div class="creator-picture-container">
                  <img src="{{message.profilePic}}" alt="" />
                </div>

                <div class="message-container">
                  <div class="message-data">
                    <span class="name">{{ message.creator }}</span>
                    <span class="date">{{ message.time }}</span>
                  </div>
                
                  <div [ngSwitch]="edit && message.creatorId == currentUser.id && editingMessage === message.id">
                    <div
                      [ngClass]="{'my-message-content': message.creatorId == currentUser.id, 'message-content': message.creatorId != currentUser.id}"
                      *ngSwitchCase="false">
                      <a (click)="openProfileDialog(messagemention['id'])"   *ngFor="let messagemention of message.mentions"> @{{messagemention['name']}}</a>
                      <span> {{message.content}}</span>
                    </div>
                    <div *ngFor="let messagefile of message.files">
                      <img style="max-height: 100px; margin-top: 10px;" *ngIf="this.authService.isImage(messagefile)" src="{{messagefile}}" alt="AngehÃ¤ngtes Bild">
                      <div class="pdf" *ngIf="this.authService.isPDF(messagefile)">
                        <img src="assets/img/icons/pdf.svg" alt="">
                        <a href="{{messagefile}}" target="_blank">Show PDF</a>
                      </div>
                    </div>
                   
                    <div *ngIf="message.creatorId == currentUser.id && editingMessage === message.id">
                      <div *ngSwitchCase="true" class="text-field-container j-flex-end">
                        <textarea #editor cols="30" rows="10">{{message.content}}</textarea>
                        <button class="send-button" mat-icon-button (click)="updateMessageContent(message)"
                          [disabled]="editor.value.length < 1">
                          <svg width="23" height="20" viewBox="0 0 23 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                              d="M2.5 19.2812C2.08333 19.4479 1.6875 19.4112 1.3125 19.1712C0.9375 18.9321 0.75 18.5833 0.75 18.125V13.4687C0.75 13.1771 0.833333 12.9167 1 12.6875C1.16667 12.4583 1.39583 12.3125 1.6875 12.25L10.75 9.99999L1.6875 7.74999C1.39583 7.68749 1.16667 7.54166 1 7.31249C0.833333 7.08333 0.75 6.82291 0.75 6.53124V1.87499C0.75 1.41666 0.9375 1.06749 1.3125 0.827493C1.6875 0.588327 2.08333 0.552076 2.5 0.718743L21.75 8.84374C22.2708 9.07291 22.5312 9.45833 22.5312 9.99999C22.5312 10.5417 22.2708 10.9271 21.75 11.1562L2.5 19.2812Z"
                              fill="#444DF2" />
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>

                  <div class="reaction-container">
                    <div class="reaction-emoji-container">
                      <button class="reaction-emoji-button" *ngFor="let emoji of message.reactionCount | keyvalue; let i = index">
                        <div 
                             (click)="firestoreService.addReaction(emoji.key, message.id, currentChat?.id, 'channels')"
                             matTooltip="{{ message.reaction[i]?.creator}}" class="emoji-fit">
                          {{ emoji.key }}
                        </div>
                        <span>{{ emoji.value }}</span>
                      </button>
                    </div>
                   
                    <div class="comment-section" (click)="openThread(message)">
                      <span *ngIf="message.threadCount == 0" class="comments color-purple2-text">Reply</span>
                      <span *ngIf="message.threadCount == 1" class="comments color-purple2-text"> 1 Comment</span>
                      <span *ngIf="message.threadCount >= 2" class="comments color-purple2-text">
                        {{message.threadCount}} Comments</span>
                      <span *ngIf="message.threadCount > 0" class="last-comment">Last Comment
                        {{message.lastThreadTime}}</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="reaction" [ngClass]="{'own-message': message.creatorId == this.userService.currentUser.id}">
                <button mat-icon-button
                  (click)="firestoreService.addReaction('âœ…',message.id, currentChat?.id, 'channels')">
                  <img src="assets/img/emojis/checkGreen.svg" alt="">
                </button>
                <button mat-icon-button
                  (click)="firestoreService.addReaction('ðŸ™Œ', message.id, currentChat?.id, 'channels')">
                  <img src="assets/img/emojis/hands.svg" alt="">
                </button>
                <button class="hostlistener-dont-trigger" (click)="openEmojiPicker(message.id)" mat-icon-button>
                  <img src="assets/img/icons/add_reaction.svg" alt="">
                </button>
                <button (click)="openThread(message)" mat-icon-button>
                  <img src="assets/img/icons/comment.svg" alt="">
                </button>
                <button mat-icon-button *ngIf="message.creatorId == currentUser.id" (click)="firestoreService.toggleMoreMenu(message)">
                  <img src="assets/img/icons/more.svg" alt="">
                </button>
                <div class="more-menu" [class.visible]="message.messageSelected">
                  <span (click)="editMessage(message)">Edit message</span>
                  <span class="delete-message" (click)="firestoreService.deleteMessageOfChat('channels', currentChat?.id, message.id)">Delete Message</span>
                </div>
              </div>

            </div>
          </section>
        </ng-container>

        <emoji-mart #emojiPicker *ngIf="this.emojiService.showMainChatEmojiPicker == true" class="emojiPicker"
          (emojiClick)="addEmoji($event)"></emoji-mart>
        <emoji-mart #emojiPicker *ngIf="this.emojiService.showTextChatEmojiPicker == true" class="emojiPicker"
          (emojiClick)="addEmojiTextField($event)"></emoji-mart>

      </mat-card-content>

      <div class="user-search-container-textfield" *ngIf="this.userService.openUserContainerTextfield.value == true" >
          <button (click)="getUserNameString(user)" class="user-container" *ngFor="let user of this.userService.users" >
              <div  class="profile-container">
                  <img src="{{user.picture}}" alt="profile">
                  <div class="online-status"></div>
              </div>
              <span>{{user.name}}</span>
          </button>
      </div>

      <mat-card-content>
        <div class="textfield-content">
          <div  class="text-field-container">
            <textarea [disabled]="!currentChat" (keyup.enter)="sendMessage()" [(ngModel)]="message.content"
              placeholder="Message to {{currentChat?.name}}"></textarea>
              <mat-spinner *ngIf="firestoreService.showSpinner == true" class="mat-spinner --purple1"></mat-spinner>
            <div class="message-buttons">
              <div class="attachments">
                <div  class="border-right">
                
                  <button class="mat-icon-button" 
                  type="submit"> <label class="custom-file-upload">
                       <input class="dataInput" (change)="onFileSelected($event)"  type="file">
                       <img style="z-index: 100;" src="assets/img/icons/add.svg" alt="" />
                     </label>
                   </button>
                </div>

                <button [disabled]="!currentChat" (click)="openEmojiPickerChat()" mat-icon-button>
                  <img src="assets/img/icons/smiley.svg" alt="" />
                </button>

                <button [disabled]="!currentChat" (click)="this.userService.openUserContainerTextField()" mat-icon-button>
                  <img src="assets/img/icons/@.svg" alt="" />
                </button>
               
                <ng-container *ngFor="let messagefile of this.message.files">
                  <img *ngIf="this.authService.isImage(messagefile) && this.showUploadedFile" src="assets/img/icons/photo.svg" alt="AngehÃ¤ngtes Bild">
                    <img *ngIf="this.authService.isPDF(messagefile) && this.showUploadedFile" src="assets/img/icons/pdf.svg" alt="">
                </ng-container>
              </div>
              <button class="send-button" mat-icon-button (click)="sendMessage()" [disabled]="!message.content">
                <svg width="23" height="20" viewBox="0 0 23 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M2.5 19.2812C2.08333 19.4479 1.6875 19.4112 1.3125 19.1712C0.9375 18.9321 0.75 18.5833 0.75 18.125V13.4687C0.75 13.1771 0.833333 12.9167 1 12.6875C1.16667 12.4583 1.39583 12.3125 1.6875 12.25L10.75 9.99999L1.6875 7.74999C1.39583 7.68749 1.16667 7.54166 1 7.31249C0.833333 7.08333 0.75 6.82291 0.75 6.53124V1.87499C0.75 1.41666 0.9375 1.06749 1.3125 0.827493C1.6875 0.588327 2.08333 0.552076 2.5 0.718743L21.75 8.84374C22.2708 9.07291 22.5312 9.45833 22.5312 9.99999C22.5312 10.5417 22.2708 10.9271 21.75 11.1562L2.5 19.2812Z" fill="#444DF2" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </mat-card-content>
    </div>
    <div *ngSwitchCase="'direct'" style="height: 100%;">
      <app-direct-message-chat style="display: flex; flex-direction: column; height: 100%;"></app-direct-message-chat>
    </div>
  </mat-card>

  <mat-drawer style="padding-right: 16px;" #thread mode="side" position="end">
    <app-thread style="width: 25%" (closeThread)="onCloseThread()"></app-thread>
  </mat-drawer>
</mat-drawer-container>